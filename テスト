#!/usr/bin/env bash
# -*- coding: utf-8 -*-
# Python バージョンチェックスクリプト
# Usage: ./テスト [MIN_VERSION]
# Default MIN_VERSION=3.8
set -euo pipefail

REQUIRED="${1:-3.8}"
# validate REQUIRED is like N or N.M
if ! [[ "$REQUIRED" =~ ^[0-9]+(\.[0-9]+)?$ ]]; then
  echo "Usage: $0 [MAJOR[.MINOR]]" >&2
  exit 3
fi

REQUIRED_MAJOR=${REQUIRED%%.*}
REQUIRED_MINOR=${REQUIRED#*.}
if [[ "$REQUIRED_MINOR" == "$REQUIRED_MAJOR" ]]; then REQUIRED_MINOR=0; fi

if ! command -v python3 >/dev/null 2>&1; then
  echo "python3 が見つかりません" >&2
  exit 1
fi

PY_INFO=$(python3 -c 'import sys; v=sys.version_info; print(v.major, v.minor, f"{v.major}.{v.minor}")')
read PY_MAJOR PY_MINOR PY_VER <<< "$PY_INFO"

# compare numerically
if (( PY_MAJOR > REQUIRED_MAJOR )) || (( PY_MAJOR == REQUIRED_MAJOR && PY_MINOR >= REQUIRED_MINOR )); then
  echo "python3 $PY_VER — OK (required >= $REQUIRED)"
  exit 0
else
  echo "python3 $PY_VER — 古い (required >= $REQUIRED)" >&2
  exit 2
fi
